<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Evacuation System | 3D Digital Twin</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #0f172a;
      color: white;
      font-family: 'Inter', sans-serif;
    }

    #canvas-container {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .ui-panel {
      position: absolute;
      z-index: 10;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .status-safe {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
      border: 1px solid #22c55e;
    }

    .status-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border: 1px solid #ef4444;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
  </style>
</head>

<body>

  <!-- 3D Canvas -->
  <div id="canvas-container"></div>

  <!-- Header / Status -->
  <div class="ui-panel top-6 left-6 w-80">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-xl font-bold text-white">Smart Building Twin</h1>
      <span id="systemStatus" class="status-badge status-safe">SYSTEM NORMAL</span>
    </div>

    <div class="space-y-3">
      <div class="flex justify-between text-sm text-gray-400">
        <span>Active Sensors</span>
        <span class="text-white font-mono">24/24</span>
      </div>
      <div class="flex justify-between text-sm text-gray-400">
        <span>Occupancy</span>
        <span class="text-white font-mono">142 People</span>
      </div>
      <div class="h-px bg-gray-700 my-2"></div>
      <div class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Live Alerts</div>
      <div id="alertsList" class="text-sm text-gray-300 italic">No active threats detected.</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="ui-panel bottom-6 left-1/2 transform -translate-x-1/2 flex gap-4">
    <button onclick="simulateFire()"
      class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
      <span>üî•</span> Simulate Fire
    </button>
    <button onclick="resetSystem()"
      class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
      Reset
    </button>
    <a href="/dashboard"
      class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2">
      <span>üìä</span> Dashboard
    </a>
  </div>

  <!-- Legend -->
  <div class="ui-panel bottom-6 right-6">
    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Legend</h3>
    <div class="space-y-2 text-sm">
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-blue-500"></div> Stairs/Lifts (Nodes)
      </div>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-green-500"></div> Safe Path
      </div>
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full bg-red-500"></div> Hazard Zone
      </div>
    </div>
  </div>

  <!-- Module Script -->
  <script type="module">
    import { initEvacuationSystem, updateSensorData } from '/js/evacuation3d.js';

    // Initialize 3D World
    initEvacuationSystem('canvas-container');

    // Socket.io Connection
    const socket = io();

    socket.on('connect', () => {
      console.log('Connected to Smart Building Network');
    });

    socket.on('sensor-update', (data) => {
      // data: { floor: 1, type: 'flame', node: 2, value: 1 }
      if (data.type === 'flame') {
        updateSensorData(data);
        if (data.value === 1) {
          updateStatus('danger', `FIRE DETECTED: Floor ${data.floor}, Node ${data.node}`);
        }
      }
    });

    // Global functions for buttons
    window.simulateFire = () => {
      const randomFloor = Math.floor(Math.random() * 4) + 1;
      const randomNode = Math.floor(Math.random() * 4) + 1;

      // Mock Data
      const mockData = {
        floor: randomFloor,
        type: 'flame',
        node: randomNode,
        value: 1
      };

      updateSensorData(mockData);
      updateStatus('danger', `SIMULATION: Fire on Floor ${randomFloor}, Node ${randomNode}`);
    };

    window.resetSystem = () => {
      location.reload();
    };

    function updateStatus(type, message) {
      const badge = document.getElementById('systemStatus');
      const list = document.getElementById('alertsList');

      if (type === 'danger') {
        badge.className = 'status-badge status-danger';
        badge.innerText = 'CRITICAL ALERT';
        list.innerHTML = `<div class="text-red-400 font-bold animate-pulse">‚ö†Ô∏è ${message}</div>`;
      } else {
        badge.className = 'status-badge status-safe';
        badge.innerText = 'SYSTEM NORMAL';
        list.innerText = 'No active threats detected.';
      }
    }
  </script>
</body>

</html>